'use client'

import { useState, useEffect, useMemo } from 'react'
import { createClient } from '@/lib/supabase/client'
import { 
  User, Calendar, MapPin, Heart, Briefcase, BookOpen, 
  Music, Film, Utensils, Target, Camera, Edit2, X, Loader2,
  Brain, Star, GraduationCap, ChevronLeft, Check, Upload, Quote, Sparkles
} from 'lucide-react'
import Link from 'next/link'
import '@/styles/home.css'
import '@/styles/page-styles.css'
import TornEdge from '@/components/ui/TornEdge'
import EssenceFingerprintLoader from '@/components/profile/EssenceFingerprintLoader'
import VoiceCloneButton from '@/components/profile/VoiceCloneButton'
import { generateEssenceVector, hasProfileData } from '@/lib/essence'
import PersonalityQuiz from '@/components/profile/PersonalityQuiz'
import { 
  OCCUPATION_OPTIONS, INTEREST_OPTIONS, LANGUAGE_OPTIONS, 
  RELIGION_OPTIONS, POLITICAL_OPTIONS, EDUCATION_LEVEL_OPTIONS,
  HOBBY_OPTIONS, SKILL_OPTIONS, LIFE_GOAL_OPTIONS, PERSONALITY_TRAIT_OPTIONS,
  BOOK_SUGGESTIONS, MOVIE_SUGGESTIONS, MUSIC_SUGGESTIONS, FOOD_SUGGESTIONS,
  QuizResult
} from '@/lib/personalityQuiz'

interface Profile {
  full_name: string
  avatar_url: string
  date_of_birth: string
  gender: string
  phone: string
  address: string
  city: string
  state: string
  country: string
  zipcode: string
  biography: string
  personal_motto: string
  personality_type: string
  personality_traits: string[]
  interests: string[]
  skills: string[]
  hobbies: string[]
  life_goals: string[]
  religions: string[]
  languages: string[]
  political_leaning: string
  occupation: string
  company: string
  education_level: string
  school_name: string
  degree: string
  favorite_quote: string
  favorite_books: string[]
  favorite_movies: string[]
  favorite_music: string[]
  favorite_foods: string[]
}

const PERSONALITY_TYPES = [
  'INTJ - Architect', 'INTP - Logician', 'ENTJ - Commander', 'ENTP - Debater',
  'INFJ - Advocate', 'INFP - Mediator', 'ENFJ - Protagonist', 'ENFP - Campaigner',
  'ISTJ - Logistician', 'ISFJ - Defender', 'ESTJ - Executive', 'ESFJ - Consul',
  'ISTP - Virtuoso', 'ISFP - Adventurer', 'ESTP - Entrepreneur', 'ESFP - Entertainer',
  'Not sure / Don\'t know'
]

const GENDER_OPTIONS = ['Male', 'Female', 'Non-binary', 'Prefer not to say']

const emptyProfile: Profile = {
  full_name: '', avatar_url: '', date_of_birth: '', gender: '', phone: '',
  address: '', city: '', state: '', country: '', zipcode: '',
  biography: '', personal_motto: '', personality_type: '',
  personality_traits: [], interests: [], skills: [], hobbies: [], life_goals: [],
  religions: [], languages: [], political_leaning: '', occupation: '', company: '', 
  education_level: '', school_name: '', degree: '',
  favorite_quote: '', favorite_books: [], favorite_movies: [], favorite_music: [], favorite_foods: [],
}

export default function ProfilePage() {
  const [profile, setProfile] = useState<Profile>(emptyProfile)
  const [editProfile, setEditProfile] = useState<Profile>(emptyProfile)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [uploading, setUploading] = useState(false)
  const [showEditModal, setShowEditModal] = useState(false)
  const [editSection, setEditSection] = useState<string | null>(null)
  const [tagInput, setTagInput] = useState('')
  const [currentTagField, setCurrentTagField] = useState<keyof Profile | null>(null)
  const [showQuiz, setShowQuiz] = useState(false)
  const supabase = createClient()

  useEffect(() => { loadProfile() }, [])

  const loadProfile = async () => {
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return

    const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single()
    if (data) {
      const loaded = {
        ...emptyProfile,
        ...data,
        personality_traits: data.personality_traits || [],
        interests: data.interests || [],
        skills: data.skills || [],
        hobbies: data.hobbies || [],
        life_goals: data.life_goals || [],
        religions: data.religions || [],
        languages: data.languages || [],
        favorite_books: data.favorite_books || [],
        favorite_movies: data.favorite_movies || [],
        favorite_music: data.favorite_music || [],
        favorite_foods: data.favorite_foods || [],
      }
      setProfile(loaded)
      setEditProfile(loaded)
    }
    setLoading(false)
  }

  const saveProfile = async () => {
    setSaving(true)
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return

    await supabase.from('profiles').update(editProfile).eq('id', user.id)
    setProfile(editProfile)
    setSaving(false)
    setShowEditModal(false)
    setEditSection(null)
  }

  const handlePhotoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return
    
    setUploading(true)
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return

    const fileExt = file.name.split('.').pop()
    const fileName = `${user.id}-${Date.now()}.${fileExt}`
    
    const { error } = await supabase.storage.from('avatars').upload(fileName, file, { upsert: true })
    if (!error) {
      const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(fileName)
      setEditProfile(p => ({ ...p, avatar_url: publicUrl }))
    }
    setUploading(false)
  }

  const addTag = (field: keyof Profile) => {
    if (!tagInput.trim()) return
    const current = editProfile[field] as string[]
    if (!current.includes(tagInput.trim())) {
      setEditProfile(p => ({ ...p, [field]: [...current, tagInput.trim()] }))
    }
    setTagInput('')
  }

  const removeTag = (field: keyof Profile, tag: string) => {
    const current = editProfile[field] as string[]
    setEditProfile(p => ({ ...p, [field]: current.filter(t => t !== tag) }))
  }

  const openEdit = (section: string) => {
    setEditProfile({ ...profile })
    setEditSection(section)
    setShowEditModal(true)
  }

  const handleQuizComplete = async (result: QuizResult) => {
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return

    const updates = {
      personality_type: result.personalityType,
      personality_traits: result.traits
    }

    await supabase.from('profiles').update(updates).eq('id', user.id)
    setProfile(p => ({ ...p, ...updates }))
    setEditProfile(p => ({ ...p, ...updates }))
  }

  const formatLocation = () => {
    const parts = [profile.city, profile.state, profile.country].filter(Boolean)
    return parts.join(', ') || 'Not specified'
  }

  // Generate essence fingerprint vector from profile data
  const essenceVector = useMemo(() => {
    return generateEssenceVector({
      id: undefined, // Will use full_name as seed
      full_name: profile.full_name,
      personality_type: profile.personality_type,
      personality_traits: profile.personality_traits,
      interests: profile.interests,
      hobbies: profile.hobbies,
      occupation: profile.occupation,
      life_goals: profile.life_goals,
      biography: profile.biography,
    })
  }, [profile])

  const calculateAge = (dob: string) => {
    if (!dob) return null
    const birth = new Date(dob)
    const today = new Date()
    let age = today.getFullYear() - birth.getFullYear()
    const m = today.getMonth() - birth.getMonth()
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--
    return age
  }

  // Tag display component
  const TagList = ({ items, colorClass = 'bg-[#406A56]/10 text-[#406A56]' }: { items: string[], colorClass?: string }) => (
    <div className="flex flex-wrap gap-2">
      {items.length > 0 ? items.map(item => (
        <span key={item} className={`px-3 py-1 rounded-full text-sm ${colorClass}`}>
          {item}
        </span>
      )) : (
        <span className="text-gray-400 text-sm italic">None added yet</span>
      )}
    </div>
  )

  // Glass card section component with optional torn edge
  const tornVariants: ('a' | 'b' | 'c' | 'd' | 'e')[] = ['a', 'b', 'c', 'd', 'e']
  const ProfileCard = ({ title, icon: Icon, iconColor = 'text-[#406A56]', bgColor = 'bg-[#406A56]/10', section, children, tornEdge = false }: {
    title: string
    icon: React.ComponentType<{ size?: number; className?: string }>
    iconColor?: string
    bgColor?: string
    section: string
    children: React.ReactNode
    tornEdge?: boolean
  }) => (
    <div className="relative mb-4">
      <div className="glass-card-page p-5 group relative">
        <button
          onClick={() => openEdit(section)}
          className="absolute top-4 right-4 p-2 opacity-0 group-hover:opacity-100 text-[#406A56]/50 hover:text-[#406A56] hover:bg-[#406A56]/10 rounded-lg transition-all z-10"
        >
          <Edit2 size={14} />
        </button>
        <div className="flex items-center gap-3 mb-4">
          <div className={`w-9 h-9 rounded-xl ${bgColor} flex items-center justify-center`}>
            <Icon size={18} className={iconColor} />
          </div>
          <h3 className="font-semibold text-[#2d2d2d]">{title}</h3>
        </div>
        {children}
      </div>
      {tornEdge && (
        <div className="absolute bottom-0 left-2 right-2 translate-y-[6px]">
          <TornEdge 
            variant={tornVariants[title.charCodeAt(0) % tornVariants.length]} 
            position="bottom" 
            color="rgba(255,255,255,0.8)" 
            height={6} 
          />
        </div>
      )}
    </div>
  )

  if (loading) {
    return (
      <div className="page-container">
        <div className="page-background">
          <div className="page-blob page-blob-1" />
          <div className="page-blob page-blob-2" />
          <div className="page-blob page-blob-3" />
        </div>
        <div className="relative z-10 flex items-center justify-center min-h-[60vh]">
          <Loader2 className="w-8 h-8 animate-spin text-[#406A56]" />
        </div>
      </div>
    )
  }

  return (
    <div className="page-container">
      {/* Background */}
      <div className="page-background">
        <div className="page-blob page-blob-1" />
        <div className="page-blob page-blob-2" />
        <div className="page-blob page-blob-3" />
      </div>

      {/* Content */}
      <div className="relative z-10 max-w-7xl mx-auto">
        {/* Header */}
        <div className="page-header mb-8">
          <Link href="/dashboard" className="page-header-back">
            <ChevronLeft size={20} />
          </Link>
          <div className="flex-1">
            <h1 className="page-header-title">My Profile</h1>
            <p className="page-header-subtitle">Your personal legacy information</p>
          </div>
        </div>

        {/* 3-Column Layout */}
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          
          {/* Left Column - Personality & Interests */}
          <div className="lg:col-span-3 space-y-4">
            {/* Personality */}
            <ProfileCard title="Personality" icon={Brain} section="personality" tornEdge>
              {profile.personality_type && (
                <div className="mb-3">
                  <span className="text-sm text-gray-500">Type</span>
                  <p className="font-medium text-[#406A56]">{profile.personality_type}</p>
                </div>
              )}
              <div className="mb-3">
                <span className="text-sm text-gray-500 block mb-2">Traits</span>
                <TagList items={profile.personality_traits} />
              </div>
              <button
                onClick={() => setShowQuiz(true)}
                className="w-full mt-3 py-2.5 px-4 bg-gradient-to-r from-[#406A56]/10 to-[#8DACAB]/10 hover:from-[#406A56]/20 hover:to-[#8DACAB]/20 text-[#406A56] font-medium rounded-xl flex items-center justify-center gap-2 transition-all border border-[#406A56]/10"
              >
                <Sparkles size={16} />
                {profile.personality_type ? 'Retake Quiz' : 'Take Personality Quiz'}
              </button>
            </ProfileCard>

            {/* Interests */}
            <ProfileCard title="Interests" icon={Heart} iconColor="text-[#C35F33]" bgColor="bg-[#C35F33]/10" section="interests">
              <TagList items={profile.interests} colorClass="bg-[#C35F33]/10 text-[#C35F33]" />
            </ProfileCard>

            {/* Hobbies */}
            <ProfileCard title="Hobbies" icon={Sparkles} iconColor="text-[#D9C61A]" bgColor="bg-[#D9C61A]/10" section="hobbies">
              <TagList items={profile.hobbies} colorClass="bg-[#D9C61A]/20 text-[#8B7B0A]" />
            </ProfileCard>

            {/* Skills */}
            <ProfileCard title="Skills" icon={Star} iconColor="text-[#8DACAB]" bgColor="bg-[#8DACAB]/10" section="skills">
              <TagList items={profile.skills} colorClass="bg-[#8DACAB]/20 text-[#5d8585]" />
            </ProfileCard>

            {/* Life Philosophy */}
            <ProfileCard title="Life Philosophy" icon={Quote} iconColor="text-[#4A3552]" bgColor="bg-[#4A3552]/10" section="philosophy" tornEdge>
              {profile.personal_motto ? (
                <p className="text-[#4A3552] italic">"{profile.personal_motto}"</p>
              ) : (
                <p className="text-gray-400 text-sm italic">No motto set</p>
              )}
              {profile.favorite_quote && (
                <div className="mt-3 pt-3 border-t border-[#4A3552]/10">
                  <span className="text-sm text-gray-500 block mb-1">Favorite Quote</span>
                  <p className="text-sm text-[#4A3552]/80 italic">"{profile.favorite_quote}"</p>
                </div>
              )}
            </ProfileCard>

            {/* Life Goals */}
            <ProfileCard title="Life Goals" icon={Target} iconColor="text-[#4A3552]" bgColor="bg-[#4A3552]/10" section="goals">
              <TagList items={profile.life_goals} colorClass="bg-[#4A3552]/10 text-[#4A3552]" />
            </ProfileCard>
          </div>

          {/* Center Column - Hero Section */}
          <div className="lg:col-span-6">
            {/* Main Profile Card - Combined with Biography */}
            <div className="glass-card-page glass-card-page-strong p-8 mb-6 group relative">
              <button
                onClick={() => openEdit('basics')}
                className="absolute top-4 right-4 p-2 opacity-0 group-hover:opacity-100 text-[#406A56]/50 hover:text-[#406A56] hover:bg-[#406A56]/10 rounded-lg transition-all"
              >
                <Edit2 size={14} />
              </button>

              {/* Avatar & Essence - Side by Side, Same Size */}
              <div className="flex items-center justify-center gap-8 mb-6">
                {/* Avatar - 140px */}
                <div className="flex-shrink-0">
                  {profile.avatar_url ? (
                    <img 
                      src={profile.avatar_url} 
                      alt={profile.full_name} 
                      className="w-[140px] h-[140px] rounded-full object-cover border-4 border-white shadow-lg"
                    />
                  ) : (
                    <div className="w-[140px] h-[140px] rounded-full bg-gradient-to-br from-[#406A56] to-[#5A8A72] flex items-center justify-center text-white text-5xl font-semibold shadow-lg border-4 border-white">
                      {profile.full_name?.charAt(0) || '?'}
                    </div>
                  )}
                </div>

                {/* Essence Fingerprint - 140px */}
                <div className="flex flex-col items-center">
                  {hasProfileData({
                    personality_type: profile.personality_type,
                    personality_traits: profile.personality_traits,
                    interests: profile.interests,
                    hobbies: profile.hobbies,
                    life_goals: profile.life_goals,
                    occupation: profile.occupation,
                    biography: profile.biography,
                  }) ? (
                    <>
                      <EssenceFingerprintLoader 
                        essenceVector={essenceVector} 
                        size={140}
                      />
                      <p className="text-xs text-[#406A56]/60 mt-1 italic">Essence Fingerprint</p>
                    </>
                  ) : (
                    <div className="w-[140px] h-[140px] rounded-full border-2 border-dashed border-[#406A56]/20 
                                    flex flex-col items-center justify-center text-center p-4">
                      <Sparkles className="w-6 h-6 text-[#406A56]/30 mb-2" />
                      <p className="text-[10px] text-[#406A56]/50">
                        Add interests or traits for Essence
                      </p>
                    </div>
                  )}
                </div>
              </div>

              {/* Name & Basic Info - Centered */}
              <div className="text-center mb-6">
                <h2 className="text-3xl font-bold text-[#2d2d2d] mb-2">
                  {profile.full_name || 'Your Name'}
                </h2>
                
                {/* Voice Clone Button */}
                <div className="mb-3">
                  <VoiceCloneButton />
                </div>
                
                {profile.occupation && (
                  <p className="text-lg text-[#406A56] mb-2">{profile.occupation}</p>
                )}
                
                <div className="flex items-center justify-center gap-4 text-gray-500 text-sm flex-wrap">
                  {profile.date_of_birth && (
                    <div className="flex items-center gap-1">
                      <Calendar size={14} />
                      <span>
                        {new Date(profile.date_of_birth).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                        {calculateAge(profile.date_of_birth) && ` (${calculateAge(profile.date_of_birth)})`}
                      </span>
                    </div>
                  )}

                  {(profile.city || profile.country) && (
                    <div className="flex items-center gap-1">
                      <MapPin size={14} />
                      <span>{formatLocation()}</span>
                    </div>
                  )}

                  {profile.gender && (
                    <span className="px-2 py-0.5 bg-[#406A56]/10 text-[#406A56] rounded-full text-xs">
                      {profile.gender}
                    </span>
                  )}
                </div>
              </div>

              {/* Biography - Merged into main card */}
              <div className="border-t border-[#406A56]/10 pt-5">
                <div className="flex items-center gap-2 mb-3">
                  <User size={16} className="text-[#406A56]" />
                  <h3 className="font-semibold text-[#2d2d2d] text-sm">About Me</h3>
                  <button
                    onClick={(e) => { e.stopPropagation(); openEdit('bio'); }}
                    className="ml-auto p-1.5 opacity-0 group-hover:opacity-100 text-[#406A56]/50 hover:text-[#406A56] hover:bg-[#406A56]/10 rounded-lg transition-all"
                  >
                    <Edit2 size={12} />
                  </button>
                </div>
                {profile.biography ? (
                  <p className="text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">{profile.biography}</p>
                ) : (
                  <p className="text-gray-400 italic text-sm">Tell your story... What makes you, you?</p>
                )}
              </div>
            </div>

            {/* Favorites Section */}
            <ProfileCard title="Favorites" icon={Star} iconColor="text-[#C35F33]" bgColor="bg-[#C35F33]/10" section="favorites" tornEdge>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <BookOpen size={14} className="text-[#406A56]" />
                    <span className="text-sm font-medium text-gray-600">Books</span>
                  </div>
                  <TagList items={profile.favorite_books} colorClass="bg-[#406A56]/10 text-[#406A56]" />
                </div>
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <Film size={14} className="text-[#4A3552]" />
                    <span className="text-sm font-medium text-gray-600">Movies</span>
                  </div>
                  <TagList items={profile.favorite_movies} colorClass="bg-[#4A3552]/10 text-[#4A3552]" />
                </div>
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <Music size={14} className="text-[#8DACAB]" />
                    <span className="text-sm font-medium text-gray-600">Music</span>
                  </div>
                  <TagList items={profile.favorite_music} colorClass="bg-[#8DACAB]/20 text-[#5d8585]" />
                </div>
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <Utensils size={14} className="text-[#C35F33]" />
                    <span className="text-sm font-medium text-gray-600">Foods</span>
                  </div>
                  <TagList items={profile.favorite_foods} colorClass="bg-[#C35F33]/10 text-[#C35F33]" />
                </div>
              </div>
            </ProfileCard>
          </div>

          {/* Right Column - Location & Professional */}
          <div className="lg:col-span-3 space-y-4">
            {/* Location */}
            <ProfileCard title="Location" icon={MapPin} section="location">
              <div className="space-y-2">
                {profile.address && (
                  <p className="text-gray-700">{profile.address}</p>
                )}
                <p className="text-gray-700">{formatLocation()}</p>
                {profile.zipcode && (
                  <p className="text-gray-500 text-sm">{profile.zipcode}</p>
                )}
                {!profile.city && !profile.country && !profile.address && (
                  <p className="text-gray-400 text-sm italic">No location added</p>
                )}
              </div>
            </ProfileCard>

            {/* Languages */}
            <ProfileCard title="Languages" icon={BookOpen} iconColor="text-[#406A56]" bgColor="bg-[#406A56]/10" section="languages">
              <TagList items={profile.languages} colorClass="bg-[#406A56]/10 text-[#406A56]" />
            </ProfileCard>

            {/* Religion */}
            <ProfileCard title="Faith & Beliefs" icon={Heart} iconColor="text-[#4A3552]" bgColor="bg-[#4A3552]/10" section="religion">
              <TagList items={profile.religions} colorClass="bg-[#4A3552]/10 text-[#4A3552]" />
            </ProfileCard>

            {/* Occupation */}
            <ProfileCard title="Work" icon={Briefcase} iconColor="text-[#D9C61A]" bgColor="bg-[#D9C61A]/10" section="work">
              {profile.occupation ? (
                <>
                  <p className="font-medium text-[#2d2d2d]">{profile.occupation}</p>
                  {profile.company && (
                    <p className="text-gray-500 text-sm mt-1">at {profile.company}</p>
                  )}
                </>
              ) : (
                <p className="text-gray-400 text-sm italic">No occupation set</p>
              )}
            </ProfileCard>

            {/* Education */}
            <ProfileCard title="Education" icon={GraduationCap} iconColor="text-[#8DACAB]" bgColor="bg-[#8DACAB]/10" section="education">
              {profile.school_name ? (
                <>
                  <p className="font-medium text-[#2d2d2d]">{profile.school_name}</p>
                  {profile.degree && (
                    <p className="text-gray-500 text-sm mt-1">{profile.degree}</p>
                  )}
                  {profile.education_level && (
                    <span className="inline-block mt-2 px-2 py-0.5 bg-[#8DACAB]/15 text-[#5d8585] rounded text-xs">
                      {profile.education_level}
                    </span>
                  )}
                </>
              ) : (
                <p className="text-gray-400 text-sm italic">No education added</p>
              )}
            </ProfileCard>

            {/* Contact Info */}
            <ProfileCard title="Contact" icon={User} section="contact">
              <div className="space-y-2">
                {profile.phone ? (
                  <p className="text-gray-700">{profile.phone}</p>
                ) : (
                  <p className="text-gray-400 text-sm italic">No phone added</p>
                )}
              </div>
            </ProfileCard>
          </div>
        </div>
      </div>

      {/* Edit Modal */}
      {showEditModal && (
        <EditModal
          section={editSection}
          profile={editProfile}
          setProfile={setEditProfile}
          onClose={() => { setShowEditModal(false); setEditSection(null) }}
          onSave={saveProfile}
          saving={saving}
          uploading={uploading}
          handlePhotoUpload={handlePhotoUpload}
          tagInput={tagInput}
          setTagInput={setTagInput}
          currentTagField={currentTagField}
          setCurrentTagField={setCurrentTagField}
          addTag={addTag}
          removeTag={removeTag}
        />
      )}

      {/* Personality Quiz */}
      <PersonalityQuiz
        isOpen={showQuiz}
        onClose={() => setShowQuiz(false)}
        onComplete={handleQuizComplete}
      />
    </div>
  )
}

// Edit Modal Component
function EditModal({
  section, profile, setProfile, onClose, onSave, saving, uploading,
  handlePhotoUpload, tagInput, setTagInput, currentTagField, setCurrentTagField, addTag, removeTag
}: {
  section: string | null
  profile: Profile
  setProfile: React.Dispatch<React.SetStateAction<Profile>>
  onClose: () => void
  onSave: () => void
  saving: boolean
  uploading: boolean
  handlePhotoUpload: (e: React.ChangeEvent<HTMLInputElement>) => void
  tagInput: string
  setTagInput: (v: string) => void
  currentTagField: keyof Profile | null
  setCurrentTagField: (v: keyof Profile | null) => void
  addTag: (field: keyof Profile) => void
  removeTag: (field: keyof Profile, tag: string) => void
}) {
  const getTitle = () => {
    switch (section) {
      case 'basics': return 'Edit Basic Info'
      case 'bio': return 'Edit Biography'
      case 'personality': return 'Edit Personality'
      case 'interests': return 'Edit Interests'
      case 'hobbies': return 'Edit Hobbies'
      case 'skills': return 'Edit Skills'
      case 'philosophy': return 'Edit Life Philosophy'
      case 'goals': return 'Edit Life Goals'
      case 'location': return 'Edit Location'
      case 'languages': return 'Edit Languages'
      case 'religion': return 'Edit Faith & Beliefs'
      case 'work': return 'Edit Work'
      case 'education': return 'Edit Education'
      case 'contact': return 'Edit Contact'
      case 'favorites': return 'Edit Favorites'
      default: return 'Edit Profile'
    }
  }

  const TagEditor = ({ field, label, placeholder, colorClass = 'bg-[#406A56]/10 text-[#406A56]' }: {
    field: keyof Profile
    label: string
    placeholder: string
    colorClass?: string
  }) => (
    <div>
      <label className="block text-sm text-[#666] mb-2">{label}</label>
      <div className="flex flex-wrap gap-2 mb-2">
        {(profile[field] as string[]).map(item => (
          <span key={item} className={`px-3 py-1 rounded-full text-sm flex items-center gap-1 ${colorClass}`}>
            {item}
            <button onClick={() => removeTag(field, item)} className="hover:text-red-500 ml-1"><X size={14} /></button>
          </span>
        ))}
      </div>
      <div className="flex gap-2">
        <input
          type="text"
          value={currentTagField === field ? tagInput : ''}
          onFocus={() => setCurrentTagField(field)}
          onChange={e => setTagInput(e.target.value)}
          onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag(field))}
          className="form-input flex-1"
          placeholder={placeholder}
        />
        <button onClick={() => addTag(field)} className="btn-secondary px-4">Add</button>
      </div>
    </div>
  )

  return (
    <div className="modal-overlay-page">
      <div className="modal-content-page max-w-lg">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-semibold text-[#2d2d2d]">{getTitle()}</h2>
          <button onClick={onClose} className="p-2 text-[#406A56]/50 hover:text-[#406A56] hover:bg-[#406A56]/10 rounded-lg">
            <X size={20} />
          </button>
        </div>

        <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
          {section === 'basics' && (
            <>
              <div className="flex justify-center mb-4">
                {profile.avatar_url ? (
                  <div className="relative">
                    <img src={profile.avatar_url} alt="Profile" className="w-28 h-28 rounded-full object-cover border-4 border-[#406A56]/20" />
                    <label className="absolute bottom-0 right-0 w-9 h-9 bg-[#406A56] text-white rounded-full flex items-center justify-center cursor-pointer hover:bg-[#355a48]">
                      <Camera size={16} />
                      <input type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" disabled={uploading} />
                    </label>
                  </div>
                ) : (
                  <label className="w-28 h-28 rounded-full border-4 border-dashed border-[#406A56]/30 flex flex-col items-center justify-center cursor-pointer hover:border-[#406A56]/50 transition-all">
                    {uploading ? <Loader2 className="w-8 h-8 text-[#406A56] animate-spin" /> : (
                      <>
                        <Upload className="w-8 h-8 text-[#406A56]/50" />
                        <span className="text-xs text-[#406A56]/50 mt-1">Add photo</span>
                      </>
                    )}
                    <input type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" disabled={uploading} />
                  </label>
                )}
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Full Name</label>
                <input
                  value={profile.full_name}
                  onChange={e => setProfile(p => ({ ...p, full_name: e.target.value }))}
                  className="form-input"
                  placeholder="Your full name"
                />
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Date of Birth</label>
                <input
                  type="date"
                  value={profile.date_of_birth}
                  onChange={e => setProfile(p => ({ ...p, date_of_birth: e.target.value }))}
                  className="form-input"
                />
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-2">Gender</label>
                <div className="flex flex-wrap gap-2">
                  {GENDER_OPTIONS.map(g => (
                    <button
                      key={g}
                      type="button"
                      onClick={() => setProfile(p => ({ ...p, gender: g }))}
                      className={`px-4 py-2 rounded-full text-sm transition-all ${
                        profile.gender === g 
                          ? 'bg-[#406A56] text-white' 
                          : 'bg-white/50 text-gray-600 border border-gray-200 hover:border-[#406A56]/30'
                      }`}
                    >
                      {g}
                    </button>
                  ))}
                </div>
              </div>
            </>
          )}

          {section === 'bio' && (
            <div>
              <label className="block text-sm text-[#666] mb-1.5">Biography</label>
              <textarea
                value={profile.biography}
                onChange={e => setProfile(p => ({ ...p, biography: e.target.value }))}
                className="form-textarea min-h-[200px]"
                placeholder="Tell your story..."
              />
            </div>
          )}

          {section === 'personality' && (
            <>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Personality Type</label>
                <select
                  value={profile.personality_type}
                  onChange={e => setProfile(p => ({ ...p, personality_type: e.target.value }))}
                  className="form-select"
                >
                  <option value="">Select your personality type</option>
                  {PERSONALITY_TYPES.map(pt => (
                    <option key={pt} value={pt}>{pt}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-2">Personality Traits</label>
                <div className="flex flex-wrap gap-2 mb-3">
                  {(profile.personality_traits || []).map(trait => (
                    <span key={trait} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#406A56]/10 text-[#406A56]">
                      {trait}
                      <button onClick={() => removeTag('personality_traits', trait)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                    </span>
                  ))}
                </div>
                <p className="text-xs text-gray-500 mb-2">Click to add traits:</p>
                <div className="max-h-40 overflow-y-auto border border-gray-200 rounded-xl p-3 bg-white/50">
                  <div className="flex flex-wrap gap-2">
                    {PERSONALITY_TRAIT_OPTIONS.filter(t => !(profile.personality_traits || []).includes(t)).map(trait => (
                      <button
                        key={trait}
                        type="button"
                        onClick={() => setProfile(p => ({ ...p, personality_traits: [...(p.personality_traits || []), trait] }))}
                        className="px-3 py-1.5 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-[#406A56]/10 hover:text-[#406A56] transition-colors"
                      >
                        + {trait}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  <input
                    type="text"
                    value={currentTagField === 'personality_traits' ? tagInput : ''}
                    onFocus={() => setCurrentTagField('personality_traits')}
                    onChange={e => setTagInput(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('personality_traits'))}
                    className="form-input flex-1"
                    placeholder="Or add a custom trait..."
                  />
                  <button onClick={() => addTag('personality_traits')} className="btn-secondary px-4">Add</button>
                </div>
              </div>
            </>
          )}

          {section === 'interests' && (
            <div>
              <label className="block text-sm text-[#666] mb-2">Interests</label>
              <div className="flex flex-wrap gap-2 mb-3">
                {(profile.interests || []).map(interest => (
                  <span key={interest} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#C35F33]/10 text-[#C35F33]">
                    {interest}
                    <button onClick={() => removeTag('interests', interest)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                  </span>
                ))}
              </div>
              <p className="text-xs text-gray-500 mb-2">Click to add interests:</p>
              <div className="max-h-48 overflow-y-auto border border-gray-200 rounded-xl p-3 bg-white/50">
                <div className="flex flex-wrap gap-2">
                  {INTEREST_OPTIONS.filter(i => !(profile.interests || []).includes(i)).map(interest => (
                    <button
                      key={interest}
                      type="button"
                      onClick={() => setProfile(p => ({ ...p, interests: [...(p.interests || []), interest] }))}
                      className="px-3 py-1.5 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-[#C35F33]/10 hover:text-[#C35F33] transition-colors"
                    >
                      + {interest}
                    </button>
                  ))}
                </div>
              </div>
              {/* Custom input for unlisted interests */}
              <div className="flex gap-2 mt-3">
                <input
                  type="text"
                  value={currentTagField === 'interests' ? tagInput : ''}
                  onFocus={() => setCurrentTagField('interests')}
                  onChange={e => setTagInput(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('interests'))}
                  className="form-input flex-1"
                  placeholder="Or add a custom interest..."
                />
                <button onClick={() => addTag('interests')} className="btn-secondary px-4">Add</button>
              </div>
            </div>
          )}

          {section === 'hobbies' && (
            <div>
              <label className="block text-sm text-[#666] mb-2">Hobbies</label>
              <div className="flex flex-wrap gap-2 mb-3">
                {(profile.hobbies || []).map(hobby => (
                  <span key={hobby} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#D9C61A]/20 text-[#8B7B0A]">
                    {hobby}
                    <button onClick={() => removeTag('hobbies', hobby)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                  </span>
                ))}
              </div>
              <p className="text-xs text-gray-500 mb-2">Click to add hobbies:</p>
              <div className="max-h-48 overflow-y-auto border border-gray-200 rounded-xl p-3 bg-white/50">
                <div className="flex flex-wrap gap-2">
                  {HOBBY_OPTIONS.filter(h => !(profile.hobbies || []).includes(h)).map(hobby => (
                    <button
                      key={hobby}
                      type="button"
                      onClick={() => setProfile(p => ({ ...p, hobbies: [...(p.hobbies || []), hobby] }))}
                      className="px-3 py-1.5 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-[#D9C61A]/20 hover:text-[#8B7B0A] transition-colors"
                    >
                      + {hobby}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex gap-2 mt-3">
                <input
                  type="text"
                  value={currentTagField === 'hobbies' ? tagInput : ''}
                  onFocus={() => setCurrentTagField('hobbies')}
                  onChange={e => setTagInput(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('hobbies'))}
                  className="form-input flex-1"
                  placeholder="Or add a custom hobby..."
                />
                <button onClick={() => addTag('hobbies')} className="btn-secondary px-4">Add</button>
              </div>
            </div>
          )}

          {section === 'skills' && (
            <div>
              <label className="block text-sm text-[#666] mb-2">Skills</label>
              <div className="flex flex-wrap gap-2 mb-3">
                {(profile.skills || []).map(skill => (
                  <span key={skill} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#8DACAB]/20 text-[#5d8585]">
                    {skill}
                    <button onClick={() => removeTag('skills', skill)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                  </span>
                ))}
              </div>
              <p className="text-xs text-gray-500 mb-2">Click to add skills:</p>
              <div className="max-h-48 overflow-y-auto border border-gray-200 rounded-xl p-3 bg-white/50">
                <div className="flex flex-wrap gap-2">
                  {SKILL_OPTIONS.filter(s => !(profile.skills || []).includes(s)).map(skill => (
                    <button
                      key={skill}
                      type="button"
                      onClick={() => setProfile(p => ({ ...p, skills: [...(p.skills || []), skill] }))}
                      className="px-3 py-1.5 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-[#8DACAB]/20 hover:text-[#5d8585] transition-colors"
                    >
                      + {skill}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex gap-2 mt-3">
                <input
                  type="text"
                  value={currentTagField === 'skills' ? tagInput : ''}
                  onFocus={() => setCurrentTagField('skills')}
                  onChange={e => setTagInput(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('skills'))}
                  className="form-input flex-1"
                  placeholder="Or add a custom skill..."
                />
                <button onClick={() => addTag('skills')} className="btn-secondary px-4">Add</button>
              </div>
            </div>
          )}

          {section === 'philosophy' && (
            <>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Personal Motto</label>
                <textarea
                  value={profile.personal_motto}
                  onChange={e => setProfile(p => ({ ...p, personal_motto: e.target.value }))}
                  className="form-textarea"
                  placeholder="What do you live by?"
                  rows={3}
                />
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Favorite Quote</label>
                <textarea
                  value={profile.favorite_quote}
                  onChange={e => setProfile(p => ({ ...p, favorite_quote: e.target.value }))}
                  className="form-textarea"
                  placeholder="A quote that inspires you..."
                  rows={3}
                />
              </div>
            </>
          )}

          {section === 'goals' && (
            <div>
              <label className="block text-sm text-[#666] mb-2">Life Goals</label>
              <div className="flex flex-wrap gap-2 mb-3">
                {(profile.life_goals || []).map(goal => (
                  <span key={goal} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#4A3552]/10 text-[#4A3552]">
                    {goal}
                    <button onClick={() => removeTag('life_goals', goal)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                  </span>
                ))}
              </div>
              <p className="text-xs text-gray-500 mb-2">Click to add goals:</p>
              <div className="max-h-48 overflow-y-auto border border-gray-200 rounded-xl p-3 bg-white/50">
                <div className="flex flex-wrap gap-2">
                  {LIFE_GOAL_OPTIONS.filter(g => !(profile.life_goals || []).includes(g)).map(goal => (
                    <button
                      key={goal}
                      type="button"
                      onClick={() => setProfile(p => ({ ...p, life_goals: [...(p.life_goals || []), goal] }))}
                      className="px-3 py-1.5 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-[#4A3552]/10 hover:text-[#4A3552] transition-colors"
                    >
                      + {goal}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex gap-2 mt-3">
                <input
                  type="text"
                  value={currentTagField === 'life_goals' ? tagInput : ''}
                  onFocus={() => setCurrentTagField('life_goals')}
                  onChange={e => setTagInput(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('life_goals'))}
                  className="form-input flex-1"
                  placeholder="Or add a custom goal..."
                />
                <button onClick={() => addTag('life_goals')} className="btn-secondary px-4">Add</button>
              </div>
            </div>
          )}

          {section === 'location' && (
            <>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Street Address</label>
                <input
                  value={profile.address}
                  onChange={e => setProfile(p => ({ ...p, address: e.target.value }))}
                  className="form-input"
                  placeholder="123 Main Street"
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-[#666] mb-1.5">City</label>
                  <input
                    value={profile.city}
                    onChange={e => setProfile(p => ({ ...p, city: e.target.value }))}
                    className="form-input"
                    placeholder="City"
                  />
                </div>
                <div>
                  <label className="block text-sm text-[#666] mb-1.5">State</label>
                  <input
                    value={profile.state}
                    onChange={e => setProfile(p => ({ ...p, state: e.target.value }))}
                    className="form-input"
                    placeholder="State"
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-[#666] mb-1.5">Country</label>
                  <input
                    value={profile.country}
                    onChange={e => setProfile(p => ({ ...p, country: e.target.value }))}
                    className="form-input"
                    placeholder="Country"
                  />
                </div>
                <div>
                  <label className="block text-sm text-[#666] mb-1.5">Zip Code</label>
                  <input
                    value={profile.zipcode}
                    onChange={e => setProfile(p => ({ ...p, zipcode: e.target.value }))}
                    className="form-input"
                    placeholder="12345"
                  />
                </div>
              </div>
            </>
          )}

          {section === 'languages' && (
            <div>
              <label className="block text-sm text-[#666] mb-2">Languages</label>
              <div className="flex flex-wrap gap-2 mb-3">
                {(profile.languages || []).map(lang => (
                  <span key={lang} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#406A56]/10 text-[#406A56]">
                    {lang}
                    <button onClick={() => removeTag('languages', lang)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                  </span>
                ))}
              </div>
              <select
                value=""
                onChange={e => {
                  const val = e.target.value
                  if (val && !(profile.languages || []).includes(val)) {
                    setProfile(p => ({ ...p, languages: [...(p.languages || []), val] }))
                  }
                }}
                className="form-select"
              >
                <option value="">Add a language...</option>
                {LANGUAGE_OPTIONS.filter(l => !(profile.languages || []).includes(l)).map(lang => (
                  <option key={lang} value={lang}>{lang}</option>
                ))}
              </select>
            </div>
          )}

          {section === 'religion' && (
            <div>
              <label className="block text-sm text-[#666] mb-2">Faith & Beliefs</label>
              <div className="flex flex-wrap gap-2 mb-3">
                {(profile.religions || []).map(rel => (
                  <span key={rel} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#4A3552]/10 text-[#4A3552]">
                    {rel}
                    <button onClick={() => removeTag('religions', rel)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                  </span>
                ))}
              </div>
              <select
                value=""
                onChange={e => {
                  const val = e.target.value
                  if (val && !(profile.religions || []).includes(val)) {
                    setProfile(p => ({ ...p, religions: [...(p.religions || []), val] }))
                  }
                }}
                className="form-select"
              >
                <option value="">Add a belief or religion...</option>
                {RELIGION_OPTIONS.filter(r => !(profile.religions || []).includes(r)).map(rel => (
                  <option key={rel} value={rel}>{rel}</option>
                ))}
              </select>
            </div>
          )}

          {section === 'work' && (
            <>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Occupation</label>
                <select
                  value={OCCUPATION_OPTIONS.includes(profile.occupation) ? profile.occupation : 'Other'}
                  onChange={e => {
                    if (e.target.value !== 'Other') {
                      setProfile(p => ({ ...p, occupation: e.target.value }))
                    }
                  }}
                  className="form-select mb-2"
                >
                  <option value="">Select an occupation</option>
                  {OCCUPATION_OPTIONS.map(occ => (
                    <option key={occ} value={occ}>{occ}</option>
                  ))}
                </select>
                {(!OCCUPATION_OPTIONS.includes(profile.occupation) || profile.occupation === 'Other' || !profile.occupation) && (
                  <input
                    value={profile.occupation === 'Other' ? '' : profile.occupation}
                    onChange={e => setProfile(p => ({ ...p, occupation: e.target.value }))}
                    className="form-input"
                    placeholder="Enter your occupation"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Company</label>
                <input
                  value={profile.company}
                  onChange={e => setProfile(p => ({ ...p, company: e.target.value }))}
                  className="form-input"
                  placeholder="Company or organization"
                />
              </div>
            </>
          )}

          {section === 'education' && (
            <>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Education Level</label>
                <select
                  value={profile.education_level}
                  onChange={e => setProfile(p => ({ ...p, education_level: e.target.value }))}
                  className="form-select"
                >
                  <option value="">Select education level</option>
                  {EDUCATION_LEVEL_OPTIONS.map(level => (
                    <option key={level} value={level}>{level}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">School / University</label>
                <input
                  value={profile.school_name}
                  onChange={e => setProfile(p => ({ ...p, school_name: e.target.value }))}
                  className="form-input"
                  placeholder="School name"
                />
              </div>
              <div>
                <label className="block text-sm text-[#666] mb-1.5">Degree</label>
                <input
                  value={profile.degree}
                  onChange={e => setProfile(p => ({ ...p, degree: e.target.value }))}
                  className="form-input"
                  placeholder="Degree or certification"
                />
              </div>
            </>
          )}

          {section === 'contact' && (
            <div>
              <label className="block text-sm text-[#666] mb-1.5">Phone Number</label>
              <input
                value={profile.phone}
                onChange={e => setProfile(p => ({ ...p, phone: e.target.value }))}
                className="form-input"
                placeholder="(555) 123-4567"
              />
            </div>
          )}

          {section === 'favorites' && (
            <>
              {/* Books */}
              <div>
                <label className="block text-sm text-[#666] mb-2">Favorite Books</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {(profile.favorite_books || []).map(book => (
                    <span key={book} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#406A56]/10 text-[#406A56]">
                      {book}
                      <button onClick={() => removeTag('favorite_books', book)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                    </span>
                  ))}
                </div>
                <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-xl p-2 bg-white/50 mb-2">
                  <div className="flex flex-wrap gap-1.5">
                    {BOOK_SUGGESTIONS.filter(b => !(profile.favorite_books || []).includes(b)).slice(0, 12).map(book => (
                      <button
                        key={book}
                        type="button"
                        onClick={() => setProfile(p => ({ ...p, favorite_books: [...(p.favorite_books || []), book] }))}
                        className="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600 hover:bg-[#406A56]/10 hover:text-[#406A56] transition-colors"
                      >
                        + {book}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={currentTagField === 'favorite_books' ? tagInput : ''}
                    onFocus={() => setCurrentTagField('favorite_books')}
                    onChange={e => setTagInput(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('favorite_books'))}
                    className="form-input flex-1 text-sm"
                    placeholder="Add another book..."
                  />
                  <button onClick={() => addTag('favorite_books')} className="btn-secondary px-3 text-sm">Add</button>
                </div>
              </div>

              {/* Movies */}
              <div>
                <label className="block text-sm text-[#666] mb-2">Favorite Movies</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {(profile.favorite_movies || []).map(movie => (
                    <span key={movie} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#4A3552]/10 text-[#4A3552]">
                      {movie}
                      <button onClick={() => removeTag('favorite_movies', movie)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                    </span>
                  ))}
                </div>
                <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-xl p-2 bg-white/50 mb-2">
                  <div className="flex flex-wrap gap-1.5">
                    {MOVIE_SUGGESTIONS.filter(m => !(profile.favorite_movies || []).includes(m)).slice(0, 12).map(movie => (
                      <button
                        key={movie}
                        type="button"
                        onClick={() => setProfile(p => ({ ...p, favorite_movies: [...(p.favorite_movies || []), movie] }))}
                        className="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600 hover:bg-[#4A3552]/10 hover:text-[#4A3552] transition-colors"
                      >
                        + {movie}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={currentTagField === 'favorite_movies' ? tagInput : ''}
                    onFocus={() => setCurrentTagField('favorite_movies')}
                    onChange={e => setTagInput(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('favorite_movies'))}
                    className="form-input flex-1 text-sm"
                    placeholder="Add another movie..."
                  />
                  <button onClick={() => addTag('favorite_movies')} className="btn-secondary px-3 text-sm">Add</button>
                </div>
              </div>

              {/* Music */}
              <div>
                <label className="block text-sm text-[#666] mb-2">Favorite Music</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {(profile.favorite_music || []).map(music => (
                    <span key={music} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#8DACAB]/20 text-[#5d8585]">
                      {music}
                      <button onClick={() => removeTag('favorite_music', music)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                    </span>
                  ))}
                </div>
                <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-xl p-2 bg-white/50 mb-2">
                  <div className="flex flex-wrap gap-1.5">
                    {MUSIC_SUGGESTIONS.filter(m => !(profile.favorite_music || []).includes(m)).slice(0, 12).map(music => (
                      <button
                        key={music}
                        type="button"
                        onClick={() => setProfile(p => ({ ...p, favorite_music: [...(p.favorite_music || []), music] }))}
                        className="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600 hover:bg-[#8DACAB]/20 hover:text-[#5d8585] transition-colors"
                      >
                        + {music}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={currentTagField === 'favorite_music' ? tagInput : ''}
                    onFocus={() => setCurrentTagField('favorite_music')}
                    onChange={e => setTagInput(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('favorite_music'))}
                    className="form-input flex-1 text-sm"
                    placeholder="Add another artist or genre..."
                  />
                  <button onClick={() => addTag('favorite_music')} className="btn-secondary px-3 text-sm">Add</button>
                </div>
              </div>

              {/* Foods */}
              <div>
                <label className="block text-sm text-[#666] mb-2">Favorite Foods</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {(profile.favorite_foods || []).map(food => (
                    <span key={food} className="px-3 py-1 rounded-full text-sm flex items-center gap-1 bg-[#C35F33]/10 text-[#C35F33]">
                      {food}
                      <button onClick={() => removeTag('favorite_foods', food)} className="hover:text-red-500 ml-1"><X size={14} /></button>
                    </span>
                  ))}
                </div>
                <div className="max-h-32 overflow-y-auto border border-gray-200 rounded-xl p-2 bg-white/50 mb-2">
                  <div className="flex flex-wrap gap-1.5">
                    {FOOD_SUGGESTIONS.filter(f => !(profile.favorite_foods || []).includes(f)).slice(0, 12).map(food => (
                      <button
                        key={food}
                        type="button"
                        onClick={() => setProfile(p => ({ ...p, favorite_foods: [...(p.favorite_foods || []), food] }))}
                        className="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600 hover:bg-[#C35F33]/10 hover:text-[#C35F33] transition-colors"
                      >
                        + {food}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={currentTagField === 'favorite_foods' ? tagInput : ''}
                    onFocus={() => setCurrentTagField('favorite_foods')}
                    onChange={e => setTagInput(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag('favorite_foods'))}
                    className="form-input flex-1 text-sm"
                    placeholder="Add another food..."
                  />
                  <button onClick={() => addTag('favorite_foods')} className="btn-secondary px-3 text-sm">Add</button>
                </div>
              </div>
            </>
          )}
        </div>

        <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-[#406A56]/10">
          <button onClick={onClose} className="btn-secondary">Cancel</button>
          <button onClick={onSave} disabled={saving} className="btn-primary">
            {saving ? <><Loader2 size={16} className="animate-spin" /> Saving...</> : <><Check size={16} /> Save</>}
          </button>
        </div>
      </div>
    </div>
  )
}
